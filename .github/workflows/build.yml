name: Build

on:
  workflow_dispatch:
    inputs:
      publish-release:
        description: 'Publish Release'
        type: boolean
        default: false
      publish-pre-release:
        description: 'Mark as Pre-Release'
        type: boolean
        default: false
      version-number:
        description: 'Version Number for Release'
        type: string
    
jobs:
  build:
    defaults:
      run:
        shell: bash
    
    strategy:
      matrix:
        include:
          - { result: Linux-x64, runs-on: ubuntu-22.04 }
          - { result: Windows-x64, runs-on: windows-2022 }
          - { result: Linux-arm, runs-on: ubuntu-22.04-arm }
          - { result: Windows-arm, runs-on: windows-2022-arm }
    
    runs-on: ${{ matrix.runs-on }}
    
    steps:
      - name: Checkout latest
        uses: actions/checkout@v5
        with:
          submodules: 'recursive'
      
      - name: Install OpenCV (Linux)
        if: ${{ matrix.result == 'Linux-x64' || matrix.result == 'Linux-arm' }}
        run: |
          sudo apt update
          sudo apt install libopencv-dev
          
      - name: Install OpenCV (Windows x64)
        if: ${{ matrix.result == 'Windows-x64' }}
        uses: johnwason/vcpkg-action@v7
        with:
          pkgs: opencv
          triplet: x64-windows-release
          token: ${{ github.token }}
          
      - name: Install OpenCV (Windows ARM)
        if: ${{ matrix.result == 'Windows-arm' }}
        uses: johnwason/vcpkg-action@v7
        with:
          pkgs: opencv
          triplet: arm-windows-release
          token: ${{ github.token }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12.x
          
      - name: Execute Pyinstaller
        run: |
          pip install pyinstaller
          pip install numpy
          cd babble_data
          python setup.py install
          cd ..
          pip install -r requirements.txt
          pyinstaller BabbleTrainer.spec
        working-directory: ./
        
      - name: Create Artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.result }}
          path: dist/
          
  release:
    needs: build
    if: ${{ github.event.inputs.publish-release == 'true' }}
    defaults:
      run:
        shell: bash
    
    runs-on: ubuntu-22.04
    
    permissions:
      contents: write
    
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: Windows
          path: ./artifacts/windows

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: Linux
          path: ./artifacts/linux

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/windows/BabbleTrainer.exe
            artifacts/linux/BabbleTrainer
          tag_name: ${{ github.event.inputs.version-number }}
          prerelease: ${{ github.event.inputs.publish-pre-release }}